---
title: 'MR-PFU: A suite of R packages for energy conversion chain analysis'
tags:
- energy
- exergy
- R
- matrix mathematics
- energy efficiency
authors:
- name: Matthew Kuperus Heun
  orcid: 0000-0002-7438-214X
  affiliation: 1
- name: Zeke Marshall
  orcid: 0000-0001-9260-7827
  affiliation: 2
- name: Paul E. Brockway
  orcid: 0000-0001-6925-8040
  affiliation: 2
- name: Emmanuel Aramendia
  orcid: 0000-0002-5964-6776
  affiliation: 2
affiliations:
- name: Engineering Department, Calvin University
  index: 1
- name: School of Earth and Environment, Leeds University
  index: 2
date: "20 July 2023"
bibliography: paper.bib
output:
  html_document:
    keep_md: yes
---

Max length: 250--1000 words. At the moment, we are at 1444 words.
But I saw many JOSS papers are longer than 1000 words. 
And our paper is describing many packages, whereas
most JOSS papers describe only a single package.
So I think we are going to be OK.
I think we can own the issue in the cover letter, 
saying that we are willing to consider splitting into
two papers upon the editor's advice. 

<!-- Define some macros to use later -->
[link-cran]:             https://cran.r-project.org
[link-ieatools]:         https://github.com/MatthewHeun/IEATools
[link-ieaweeb]:          https://www.iea.org/data-and-statistics/data-product/world-energy-balances
[link-ilo]:              https://www.ilo.org/
[link-fao]:              https://www.fao.org/
[link-matsbyname]:       https://github.com/MatthewHeun/matsbyname
[link-matsindf]:         https://github.com/MatthewHeun/matsindf
[link-mwtools]:          https://github.com/EnergyEconomyDecoupling/MWTools
[link-pfusetup]:         https://github.com/EnergyEconomyDecoupling/PFUSetup
[link-pfudatabase]:      https://github.com/EnergyEconomyDecoupling/PFUDatabase
[link-pfuaggdatabase]:   https://github.com/EnergyEconomyDecoupling/PFUAggDatabase
[link-pfupipelinetools]: https://github.com/EnergyEconomyDecoupling/PFUPipelineTools
[link-rclabels]:         https://github.com/MatthewHeun/RCLabels
[link-recca]:            https://github.com/MatthewHeun/Recca
[link-targets]:          https://docs.ropensci.org/targets
[link-tidyverse]:        https://www.tidyverse.org


# Summary

Energy flowing through societal energy conversion chains (ECCs)
enables economic activity and facilitates human flourishing.
To understand economic growth and human well-being, 
the field of societal energy analysis (among other activities)
evaluates ECCs
from the primary stage 
(resources extracted from the environment, 
such as coal, oil, natural gas, wind, and solar) 
to the final stage
(energy purchased by consumers, 
such as refined petroleum and electricity),
to the useful stage
(energy desired by the end user, 
such as heat, motion, and light),
and sometimes to energy services
(such as thermal comfort, transport, and illumination).
Societal _exergy_ analysis (SEA), 
an extension of societal _energy_ analysis,
quantifies ECCs in exergy terms^[Exergy is 
the mechanical work potential of energy.
See any number of web references for an exergy primer,
including @SciDirect:2023. 
**** Do we have a better primer? ****].

We created a suite of `R` packages 
to assist SEA practitioners to analyze 
energy movement through society. 
The new packages enable analysis of any country in the world
across timespans of decades or longer.
In short, the packages enable, for the first time, scalable SEA.
We used the new packages to create the MR-PFU database,^["MR-PFU" 
is an initialism for "Multi-Region
Primary, Final, Useful."
The MR-PFU database is "multi-regional" in the sense that
it contains many countries as well as 
continental and world aggregations.
Technically speaking, 
we create [matsindf][link-matsindf] data frames, 
not SQL or similar databases.] 
a new resource for the SEA community [@Marshall:2023aa]. 

This paper describes the design of the new packages and
demonstrates briefly their use.


# Statement of need

Historically, SEA practitioners have
analyzed the ECCs of individual countries
using linked spreadsheets,
often starting with primary- and final-stage data 
from the [IEA][link-ieaweeb]'s
world energy balances
[@Ayres:2003ec; @Serrenho:2014aa; @Brockway:2014aa; @Brockway:2015aa]. 
Data were stored in varying and inconsistent formats.
An early SEA database [@De-Stercke:2014]
estimated energy efficiencies 
of end-use machines by the economic status of countries,
thereby precluding its use for energy-economy studies.

The authors of the current paper and others in the field
wanted to expand SEA to cover all countries, but
the spreadsheet approach to SEA was
deemed not scalable.
A new approach to SEA was needed, 
one that scaled across all countries 
for many years without relying on economic data
to estimate machine efficiencies. 


# Design of `R` packages

The most important design decision for the suite of `R` packages
involved data format.
We authors are among those who
developed the Physical Supply-Use Table (PSUT) framework,
a matrix-based approach to describing energy flows 
("products" in PSUT terminology) 
from resource extraction to
processing stages
("industries" in PSUT terminology)
and, ultimately, 
to final demand [@Rocco:2016; @Guevara:2017; @Heun:2018; @Aramendia:2022tv].
We chose the PSUT framework as the data format for the new `R` packages, 
because it succinctly describes an entire ECC
for one country and one year
via a set of six matrices
(the "RUVY" matrices).
See the following table.

| Matrix        | rows x columns     | Name                           | Description                                              |
|:--------------|:-------------------|:-------------------------------|:---------------------------------------------------------|
| **R**         | industry x product | Resource matrix                | Contains exogeneous energy inputs to an ECC              |
| **U**         | product x industry | Use matrix                     | Describes how each energy conversion device uses energy; the sum of **U**~feed~ and **U**~EIOU~ |
| **U**~feed~   | product x industry | Feedstock use matrix           | Describes feedstock inputs to energy conversion devices  |
| **U**~EOIU~   | product x industry | Energy industry own use matrix | Describes how the energy industry uses energy            |
| **V**         | industry x product | Make matrix                    | Describes how each energy conversion device makes energy |
| **Y**         | product x industry | Final demand matrix            | Describes how each energy carrier is consumed            |

Further development followed selection of the PSUT framework.
First, the RUVY matrices carry the challenge that 
different countries and years 
have varying energy carriers (products) and
varying energy conversion machines (industries),
meaning that RUVY matrices 
have differing row names, differing column names, and differing sizes.
To get around this challenge, we created the
[matsbyname][link-matsbyname] package [@Heun-matsbyname:2023]
which enables matrix mathematics 
that respects row and column names, 
inserting **0** vectors when needed.
Second,
wanted to be able to perform _matrix_ mathematics 
as easily as _scalar_ mathematics
in `R` data frames
using the [tidyverse][link-tidyverse] syntax [@Wickham:2019]. 
We developed the [matsindf][link-matsindf] package [@Heun-matsindf:2023]
to enable this functionality.
Finally, manipulating row and column names proved to be a challenge, 
especially for RUVY matrices in [matsindf][link-matsindf] data frames, so 
we developed the [RCLabels][link-rclabels] package [@Heun-RCLabels:2023]
to assist.
The table below summarizes these packages, 
all of which are generally useful and available on 
[CRAN][link-cran].

| Package | Purpose |
|:--------|:--------|
| [RCLabels][link-rclabels]     | Manipulates matrix row and column names in [matsindf][link-matsindf] data frames |
| [matsbyname][link-matsbyname] | Performs matrix mathematics that respects row and column names |
| [matsindf][link-matsindf]     | Stores matrices in cells of data frames, thereby enabling analysis with [tidyverse][link-tidyverse] syntax |


Broadly speaking, 
four calculation steps are required to create a MR-PFU database. 
Each step is assisted by functions in one or more new `R` packages.
First, the IEA's primary- and final-stage WEEB data must be converted
to RUVY matrices for each country and year, 
a task accomplished by functions in the [IEATools][link-ieatools] package [@Heun-IEATools:2023]. 
Second, human and animal muscle work must be calculated from 
[International Labor Organization][link-ilo] (ILO) and
[Food and Agriculture Organization][link-fao] (FAO) data,
following the methodology of @Steenwyk:2022ww, 
using functions in the [MWTools][link-mwtools] package [@Marshall:2023ab]. 
Third, the IEA's primary- and final-stage ECC data 
must be extended to the useful stage by
(a) allocating final stage energy to end-use machines and
(b) multiplying allocated final energy by the 
final-to-useful efficiency of each machine.
This task is accomplished by functions in the
[Recca][link-recca] [@Heun-Recca:2023]
and 
[PFUDatabase][link-pfudatabase] [@Heun-PFUDatabase:2023]
packages.
Fourth, ECCs must be converted from energy terms to exergy terms. 
This step is performed by functions in the [Recca][link-recca] package.

The steps to create the PSUT matrices for each country and each year
are accomplished by a
[targets][link-targets] [@Landau:2021aa]
computation pipeline
available in the [PFUDatabase][link-pfudatabase]
package.
A unique feature of the
[PFUDatabase][link-pfudatabase]
pipeline is an exemplar system that allows
analyses to proceed when allocation or efficiency data for a country are unavailable.
The calculation pipeline in the [PFUDatabase][link-pfudatabase] packge 
allows allocation and efficiency data
for any country and year to be added at any time to improve the database. 

A second [targets][link-targets] pipeline 
in the [PFUAggDatabase][link-pfuaggdatabase] package [@Heun-PFUAggDatabase:2023]
aggregates ECCs
(a) by region 
(continents and world),
(b) by energy carrier (product) category 
(e.g., Coal and coal products, 
Low-, Medium-, and High-temperature heat, etc.), 
(c) by energy conversion machines (industries) and end use sectors
(e.g., Residential, Transport, etc.), and
(d) to primary, final, and useful (PFU) stages.
The [PFUAggDatabase][link-pfuaggdatabase]
pipeline uses the [Recca][link-recca] package extensively.

Both [targets][link-targets] pipelines 
(in the [PFUDatabase][link-pfudatabase] and
[PFUAggDatabase][link-pfuaggdatabase] packages)
benefit from the 
[PFUSetup][link-pfusetup] [@Heun-PFUSetup:2023] and
[PFUPipelineTools][link-pfupipelinetools] [@Heun-PFUPipelineTools:2023]
packages. 
[PFUSetup][link-pfusetup] identifies storage locations 
for pipeline input and output data.
[PFUPipelineTools][link-pfupipelinetools] provides functions and constants
common to both pipelines. 

The packages in the following table are specific to SEA analyses
and are available on GitHub.

| Package | Purpose |
|:--------|:--------|
| [IEATools][link-ieatools]             | Converts [IEA WEEB][link-ieaweeb] data to RUVY matrices in [matsindf][link-matsindf] data frames |
| [MWTools][link-mwtools]               | Converts [ILO][link-ilo] and [FAO][link-fao] data to RUVY matrices of human and animal muscle work in [matsindf][link-matsindf] data frames |
| [Recca][link-recca]                   | Performs `R` energy conversion chain analysis |
| [PFUSetup][link-pfusetup]             | Identifies input and output locations for the [PFUDatabase][link-pfudatabase] and [PFUAggDatabase][link-pfuaggdatabase] pipelines |
| [PFUPipelineTools][link-pfupipelinetools] | Provides basic functionality for all PFU pipelines |
| [PFUDatabase][link-pfudatabase]       | Provides a [targets][link-targets] pipeline to create a data frame of RUVY matrices |
| [PFUAggDatabase][link-pfuaggdatabase] | Provides a [targets][link-targets] pipeline to aggregate RUVY matrices |

Input data for the PFU database can be found in @Marshall:2023aa.
Access to the PFU database can be obtained via correspondence 
with author [PEB](mailto:P.E.Brockway@leeds.ac.uk)^[Because the PFU Database contains
primary and final energy [IEA WEEB][link-ieaweeb] data, 
use of the PFU Database
is restricted to those who have access to [IEA WEEB][link-ieaweeb] data.].


# Example

```{r}
# Available on CRAN
# library(matsbyname)
# library(matsindf)
# library(RCLabels)

# Available from MatthewHeun on GitHub
# with devtools::install_github("MatthewHeun/xxxxxx")
# library(IEATools)

# Available from EnergyEconomyDecoupling on GitHub
# with devtools::install_github("EnergyEconomyDecoupling/xxxxxx")
# library(PFUPipelineTools)
library(PFUSetup)

# Use the PFUSetup package to establish paths for the example
home_path <- "ExampleFolder"
iea_folder_path <- file.path(home_path, "IEA extended energy balance data")
iea_data_path <- file.path("IEA extended energy balance data",
                           "GH-ZA-TJ-Extended-Energy-Balances-sample-2022.csv")
setup <- PFUSetup::get_abs_paths(home_path = file.path("ExampleFolder"), 
                                 dropbox_path = "",
                                 project_path = "",
                                 iea_folder_path = iea_folder_path,
                                 iea_data_path = iea_data_path,
                                 version = "v_example")
```

Create a MR-PFU database from the GHA and ZAF data contained in the IEATools package.   
Create the folder structure for the MR-PFU database.   
Store all necessary data in this repository.   
Execute the commands to produce the database, 
albeit for only two countries and two years.


# Conclusion

The new `R` packages described in this paper
enable the creation of databases of primary, final, and useful
energy and exergy conversion chains.
Such databases will enable advances in the societal exergy analysis community
and lead to greater insights 
about the role of energy 
in economic growth and human well-being.





<!-- # Mathematics -->

<!-- Single dollars ($) are required for inline mathematics e.g. $f(x) = e^{\pi/x}$ -->

<!-- Double dollars make self-standing equations: -->

<!-- $$\Theta(x) = \left\{\begin{array}{l} -->
<!-- 0\textrm{ if } x < 0\cr -->
<!-- 1\textrm{ else} -->
<!-- \end{array}\right.$$ -->

<!-- You can also use plain \LaTeX for equations -->
<!-- \begin{equation}\label{eq:fourier} -->
<!-- \hat{f}(\omega) = \int_{-\infty}^{\infty} f(x) e^{i\omega x} dx -->
<!-- \end{equation} -->
<!-- and refer to \autoref{eq:fourier} from text. -->

<!-- # Figures -->

<!-- Figures can be included like this: -->

<!-- ![Caption for example figure.\label{fig:example}](figure.png) -->
<!-- and referenced from text using \autoref{fig:example}. -->

<!-- Figure sizes can be customized by adding an optional second parameter: -->

<!-- ![Caption for example figure.](figure.png){ width=20% } -->


# Acknowledgements

MKH acknowledges the support of Calvin University for 
a sabbatical during which he developed the PSUT framework
and course releases during which he wrote many of the `R` packages
described in this paper.
ZM's and PEB's time was funded by 
the UK Research Council under EPSRC Fellowship award EP/R024254/1.
EA's time was funded by 
the University of Leeds (School of Earth and Environment).


# References

**** Change to Zenodo DOIs for all package references?. ****
