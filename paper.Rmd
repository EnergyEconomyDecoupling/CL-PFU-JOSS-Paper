---
title: 'CL-PFU: A suite of R packages for energy conversion chain analysis'
tags:
- energy
- exergy
- R
- matrix mathematics
- energy efficiency
authors:
- name: Matthew Kuperus Heun
  orcid: 0000-0002-7438-214X
  affiliation: 1
- name: Zeke Marshall
  orcid: 0000-0001-9260-7827
  affiliation: 2
- name: Paul E. Brockway
  orcid: 0000-0001-6925-8040
  affiliation: 2
- name: Emmanuel Aramendia
  orcid: 0000-0002-5964-6776
  affiliation: 2
affiliations:
- name: Engineering Department, Calvin University
  index: 1
- name: School of Earth and Environment, University of Leeds
  index: 2
# date: "17 Aug 2023"
bibliography: paper.bib
output:
  html_document:
    keep_md: yes
---

<!-- Message to editors: -->

<!-- This paper describes a suite of packages -->
<!-- to assist Societal Exergy Analysis practitioners to analyze -->
<!-- energy movement through society. -->
<!-- The new packages enable analysis of any country in the world -->
<!-- across timespans of decades or longer. -->
<!-- In short, the packages enable, for the first time, scalable SEA. -->

<!-- In an email exchange in late July 2021, -->
<!-- editor Afron Smith recommended that we -->
<!-- create a separate repository for the paper, -->
<!-- mentioning all of the individual packages in the manuscript. -->
<!-- Thus, the paper is slightly longer than 1000 words. -->
<!-- That said, we are willing to consider splitting into -->
<!-- two papers upon the editor's advice. -->

<!-- No portion of this paper has been submitted or published -->
<!-- in another peer-reviewed journal. -->
<!-- A paper with a very different focus -->
<!-- (efficiency results from the full CL-PFU database) -->
<!-- is in preparation for the IOP journal -->
<!-- Environmental Research: Energy. -->
<!-- It is our desire that the Environmental Research: Energy -->
<!-- paper will reference this JOSS paper. -->

<!-- Thank you for considering our paper. -->

<!-- ---Matthew Kuperus Heun, 17 August 2023 -->



<!-- Define some macros for later use -->
[link-cran]:             https://cran.r-project.org
[link-ecctools]:         https://github.com/earamendia/ECCTools
[link-eroitools]:        https://github.com/earamendia/EROITools
[link-iea]:              https://www.iea.org
[link-ieatools]:         https://github.com/MatthewHeun/IEATools
[link-ieaweb]:           https://www.iea.org/data-and-statistics/data-product/world-energy-balances
[link-ilo]:              https://www.ilo.org/
[link-fao]:              https://www.fao.org/
[link-matsbyname]:       https://github.com/MatthewHeun/matsbyname
[link-matsindf]:         https://github.com/MatthewHeun/matsindf
[link-mwtools]:          https://github.com/EnergyEconomyDecoupling/MWTools
[link-pfusetup]:         https://github.com/EnergyEconomyDecoupling/PFUSetup
[link-pfudatabase]:      https://github.com/EnergyEconomyDecoupling/PFUDatabase
[link-pfuaggdatabase]:   https://github.com/EnergyEconomyDecoupling/PFUAggDatabase
[link-pfupipelinetools]: https://github.com/EnergyEconomyDecoupling/PFUPipelineTools
[link-pins]:             https://pins.rstudio.com
[link-rclabels]:         https://github.com/MatthewHeun/RCLabels
[link-recca]:            https://github.com/MatthewHeun/Recca
[link-targets]:          https://docs.ropensci.org/targets
[link-tidyverse]:        https://www.tidyverse.org


# Summary

Energy flowing through societal energy conversion chains (ECCs)
enables economic activity and facilitates human flourishing.
To understand economic growth and human well-being, 
the field of societal energy analysis [@Common:1976wn]
evaluates ECCs
from the primary stage 
(resources extracted from the environment, 
such as coal, oil, natural gas, wind, and solar),
to the final stage
(energy purchased by consumers, 
such as refined petroleum and electricity),
to the useful stage
(energy desired by the end user, 
such as heat, motion, and light),
and sometimes to energy services
(such as thermal comfort, transport, and illumination).
Societal _exergy_ analysis (SEA) [@Ertesvaag:2001], 
an extension of societal _energy_ analysis,
quantifies ECCs in exergy terms^[Exergy is 
the mechanical work potential of energy.
See any number of internet references for an exergy primer,
including @SciDirect:2023.].

We created a suite of `R` packages 
to assist SEA practitioners to analyze ECCs. 
The new packages enable analysis of any country in the world
across timespans of decades or longer.
In short, the new packages enable, for the first time, scalable SEA.
We used the new packages to create the CL-PFU database^["CL-PFU" 
is an initialism for "Country-Level
Primary, Final, and Useful."
The CL-PFU database contains many countries as well as 
continental and world aggregations.
Technically speaking, 
we create [matsindf][link-matsindf] data frames
stored as [pins][link-pins] on a pinboard, 
not SQL or similar databases.],
a new resource for the SEA community [@Marshall:2023aa]. 

This paper describes the design of the new packages and
demonstrates briefly their use.


# Statement of need

Historically, SEA practitioners have
analyzed the ECCs of individual countries
using linked spreadsheets,
often starting with primary- and final-stage data 
from the [International Energy Agency][link-iea]'s (IEA's)
[world energy balances][link-ieaweb] (WEBs)
[@Ayres:2003ec; @Serrenho:2014aa; @Brockway:2014aa; @Brockway:2015aa]. 
Data were stored in varying and inconsistent formats.
An early SEA database [@De-Stercke:2014]
estimated energy efficiencies 
of end-use machines using the economic status of countries,
thereby precluding use in energy-economy studies.

The authors of the current paper and others in the field
wanted to expand SEA to cover all countries, but
the spreadsheet approach to SEA was
deemed not scalable.
A new approach to SEA was needed, 
one that scaled across all countries 
for many years without relying on economic data
to estimate machine efficiencies. 


# Design of `R` packages

The most important design decision for the suite of `R` packages
involved data format.
We authors are among those who
developed the Physical Supply-Use Table (PSUT) framework
[@Rocco:2016; @Guevara:2017; @Heun:2018; @Aramendia:2022tv],
an adaptation of economic Input-Output (IO) analysis [@Miller:2009]
to describe energy flows through society.
The Physical Supply-Use Table (PSUT) framework 
is a matrix-based approach that tracks energy flows 
("products" in PSUT terminology) 
from resource extraction to
processing stages
("industries" in PSUT terminology)
and, ultimately, 
to final demand
in a way that is compatible with the [IEA][link-iea]'s
[WEB][link-ieaweb] data
[@International-Energy-Agency:2023aa].
We chose the PSUT framework as the data format for the new `R` packages, 
because it succinctly describes an entire ECC
for one country and one year
via a set of six matrices
(the "RUVY" matrices).
See the following table.

| Matrix        | rows x columns     | Name                           | Description                                              |
|:--------------|:-------------------|:-------------------------------|:---------------------------------------------------------|
| **R**         | industry x product | Resource matrix                | Contains exogeneous energy inputs to an ECC              |
| **U**         | product x industry | Use matrix                     | Describes how each energy conversion device uses energy; the sum of **U**~feed~ and **U**~EIOU~ |
| **U**~feed~   | product x industry | Feedstock use matrix           | Describes feedstock inputs to energy conversion devices  |
| **U**~EOIU~   | product x industry | Energy industry own use matrix | Describes how the energy industry uses energy            |
| **V**         | industry x product | Make matrix                    | Describes how each energy conversion device makes energy |
| **Y**         | product x industry | Final demand matrix            | Describes how each energy carrier is consumed            |

Further development followed selection of the PSUT framework.
First, the RUVY matrices carry the challenge that 
different countries and years 
have varying energy carriers (products) and
varying energy conversion machines (industries),
meaning that RUVY matrices 
have differing row names, differing column names, and differing sizes
from one country to another and for different years within the same country.
To circumvent this challenge, we created the
[matsbyname][link-matsbyname] package [@Heun-matsbyname:2023]
which enables matrix mathematics 
that respects row and column names, 
inserting **0** row or column vectors when needed.
Second,
we wanted to be able to perform _matrix_ mathematics 
as easily as _scalar_ mathematics
in `R` data frames
using [tidyverse][link-tidyverse] syntax [@Wickham:2019]. 
We developed the [matsindf][link-matsindf] package [@Heun-matsindf:2023]
to enable this functionality.
Finally, manipulating row and column names proved to be a challenge, 
especially for RUVY matrices in [matsindf][link-matsindf] data frames, so 
we developed the [RCLabels][link-rclabels] package [@Heun-RCLabels:2023]
to assist.
The table below summarizes these packages, 
all of which are generally useful and available on 
[CRAN][link-cran].

| Package | Purpose |
|:--------|:--------|
| [RCLabels][link-rclabels]     | Manipulates matrix row and column names in [matsindf][link-matsindf] data frames |
| [matsbyname][link-matsbyname] | Performs matrix mathematics that respects row and column names |
| [matsindf][link-matsindf]     | Stores matrices in cells of data frames, thereby enabling analyses with [tidyverse][link-tidyverse] syntax |

Broadly speaking, 
four calculation steps are required to create a CL-PFU database. 
Each step is assisted by functions in one or more of the new `R` packages.
First, the IEA's primary- and final-stage 
WEB data must be converted
to RUVY matrices for each country and year, 
a task accomplished by functions in the [IEATools][link-ieatools] package [@Heun-IEATools:2023]. 
Second, human and animal muscle work must be calculated from 
[International Labor Organization][link-ilo] (ILO) and
[Food and Agriculture Organization][link-fao] (FAO) data,
following the methodology of @Steenwyk:2022ww, 
using functions in the [MWTools][link-mwtools] package [@Marshall:2023ab]. 
Third, the IEA's primary- and final-stage ECC data 
must be extended to the useful stage by
(a) allocating final stage energy to end-use machines and
(b) multiplying allocated final energy by the 
final-to-useful efficiency of each machine.
This task is accomplished by functions in the
[Recca][link-recca] [@Heun-Recca:2023]
package.
Fourth, ECCs must be converted from energy terms to exergy terms. 
This step is also performed by functions in the [Recca][link-recca] package.

The steps to create the PSUT matrices for each country and each year
are accomplished by a
[targets][link-targets] [@Landau:2021aa]
computation pipeline
available in the [PFUDatabase][link-pfudatabase]
package.
A unique feature of the
[PFUDatabase][link-pfudatabase]
pipeline enabled by the [Recca][link-recca] package 
is an innovative exemplar system that allows
analyses to proceed when allocation or efficiency data are unavailable for a country.
When allocations or efficiencies are missing,
a string of exemplar countries or regions
are queried for the required information.
For example, exemplars for Belgium are
France, Europe, and ultimately, the World, in that order.
The design of the calculation pipeline in the [PFUDatabase][link-pfudatabase] package 
allows allocation and efficiency data
for any country or year to be added at a later date 
to improve the database. 

A second [targets][link-targets] pipeline 
in the [PFUAggDatabase][link-pfuaggdatabase] package [@Heun-PFUAggDatabase:2023]
aggregates ECCs
(a) by region 
(e.g., continents and world),
(b) by energy carrier (product) category 
(e.g., Coal and coal products, 
Low-, Medium-, and High-temperature heat, etc.), 
(c) by energy conversion machines (industries) and end use sectors
(e.g., Residential, Transport, etc.), and
(d) to primary, final, and useful (PFU) stages.
In addition, the [PFUAggDatabase][link-pfuaggdatabase] pipeline 
calculates efficiencies for each country
at all available aggregations.
The [PFUAggDatabase][link-pfuaggdatabase]
pipeline uses the [Recca][link-recca] package extensively.

Both [targets][link-targets] pipelines 
(in the [PFUDatabase][link-pfudatabase] and
[PFUAggDatabase][link-pfuaggdatabase] packages)
produce data frames readable by the [pins][link-pins] package [@Silga:2023].
Both pipelines benefit from the 
[PFUSetup][link-pfusetup] [@Heun-PFUSetup:2023] and
[PFUPipelineTools][link-pfupipelinetools] [@Heun-PFUPipelineTools:2023]
packages. 
[PFUSetup][link-pfusetup] identifies storage locations 
for pipeline input and output data.
[PFUPipelineTools][link-pfupipelinetools] provides functions and constants
common to both pipelines. 

The packages in the following table are available on GitHub.

| Package | Purpose |
|:--------|:--------|
| [IEATools][link-ieatools]             | Converts [IEA WEB][link-ieaweb] data to RUVY matrices in [matsindf][link-matsindf] data frames |
| [MWTools][link-mwtools]               | Converts [ILO][link-ilo] and [FAO][link-fao] data to RUVY matrices of human and animal muscle work in [matsindf][link-matsindf] data frames |
| [Recca][link-recca]                   | Performs `R` energy conversion chain analysis |
| [PFUSetup][link-pfusetup]             | Identifies input and output locations for the [PFUDatabase][link-pfudatabase] and [PFUAggDatabase][link-pfuaggdatabase] pipelines |
| [PFUPipelineTools][link-pfupipelinetools] | Provides basic functionality for all PFU pipelines |
| [PFUDatabase][link-pfudatabase]       | Provides a [targets][link-targets] pipeline to create a data frame of RUVY matrices |
| [PFUAggDatabase][link-pfuaggdatabase] | Provides a [targets][link-targets] pipeline to aggregate RUVY matrices |

Input data for the PFU database can be found in @Marshall:2023aa.
Access to the full CL-PFU database can be obtained via correspondence 
with author [PEB](mailto:P.E.Brockway@leeds.ac.uk)^[Because the PFU Database contains
primary and final energy [IEA WEB][link-ieaweb] data, 
use of the PFU Database
is restricted to those who have access to [IEA][link-iea] [WEB][link-ieaweb] data.].
If desired, researchers with access to the 
[IEA][link-iea]'s [WEB][link-ieaweb] 
data can create their own CL-PFU database 
following the example below.


# Example

```{r, eval=FALSE}
# (1) Purchase, download, and store IEA WEB data in the correct location.
#     Sample data for two countries (Ghana and South Africa) 
#     and two years (1971 and 2000) are included (with permission)
#     at the correct location in the repository for this paper.
# (2) Download FAO and ILO data for muscle work calculations
#     via the included script.
#     This download step is needed only once, and
#     downloaded data are stored in the repository 
#     for this paper.
source(file.path("ExampleFolder", "DownloadScripts", "download_mw_data.R"))
```

```{r, eval=FALSE}
# (3) Run the PFUDatabase pipeline to create RUVY matrices.
targets::tar_make_future(script = file.path("ExampleFolder", "_targets_pfudatabase.R"), 
                         workers = 4)
# (4) Run the PFUAggDatabase pipeline to aggregate 
#     energy and calculate efficiencies.
targets::tar_make_future(script = file.path("ExampleFolder", "_targets_pfuaggdatabase.R"),
                         workers = 4)
```

```{r}
# (5) Review results using the pins package.
#     Establish the pinboard.
pinboard <- file.path("ExampleFolder", "OutputData", "PipelineReleases") |> 
  pins::board_folder(versioned = TRUE)
#     Look at the psut data frame
#     created by the PFUDatabase pipeline.
psut <- pinboard |>
  pins::pin_read(name = "psut", version = "20230811T122618Z-3b7b3")
head(psut)
#     Each column of the psut data frame contains sparse matrices, 
#     the columns of which are suppressed on display.
#     Show the column names here.
colnames(psut$R[[1]])
#     Show an example resource (R) matrix.
psut$R[[1]]

#     Review the aggregate PFU efficiency data frame
#     created by the PFUAggDatabase pipeline.
agg_eta_pfu <- pinboard |> 
  pins::pin_read(name = "agg_eta_pfu", version = "20230817T180346Z-45741")
agg_eta_pfu |> 
#     Filter and delete columns 
#     to present a subset of exergy results in a data frame.
#     The EX.p, EX.f, and EX.u columns contain aggregate exergy at
#     primary, final, and useful stages, respectively, in TJ.
#     The eta_pf, eta_fu, and eta_pu columns contain aggregate
#     primary-to-final, final-to-useful, and 
#     primary-to-useful efficiencies.
  dplyr::filter(Energy.type == "X", IEAMW == "Both", 
                Product.aggregation == "Specified", 
                Industry.aggregation == "Specified", 
                GrossNet == "Net",
                Country %in% c("GHA", "ZAF")) |> 
  dplyr::mutate(
    Method = NULL, 
    Energy.type = NULL,
    Product.aggregation = NULL,
    Industry.aggregation = NULL,
    IEAMW = NULL,
    Chopped.mat = NULL, 
    Chopped.var = NULL, 
    GrossNet = NULL
  )
```


# Conclusion

The new `R` packages described in this paper
enable the creation of databases of primary, final, and useful
energy and exergy conversion chains.
Such databases will enable advances in societal exergy analysis
and lead to new insights 
about the role of energy 
in economic growth and human well-being.
An example of early work using the CL-PFU database
is the calculation of useful stage 
Energy Return On Investment (EROI) for fossil fuels [@Aramendia:2023aa], 
for which the [ECCTools][link-ecctools] [@Aramendia:2022aa] and
[EROITools][link-eroitools] [@Aramendia:2022ab] packages were developed, 
expanding the software capabilities introduced here^[Note
that the [ECCTools][link-ecctools] and [EROITools][link-eroitools] packages 
are not the subject of this paper and were not peer reviewed.].


# Acknowledgements

MKH acknowledges the support of Calvin University for 
a sabbatical during which he developed the PSUT framework
and course releases during which he wrote many of the `R` packages
described in this paper.
ZM's and PEB's time was funded by 
the UK Research Council under EPSRC Fellowship award EP/R024254/1.
EA's time was funded by 
the University of Leeds (School of Earth and Environment).


# References
